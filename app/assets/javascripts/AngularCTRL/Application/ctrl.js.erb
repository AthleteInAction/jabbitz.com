// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
// APPLICATION !!!!!!! APPLICATION !!!!!!! APPLICATION !!!!!!! APPLICATION !!!!!!! APPLICATION !!!!!!!
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
var Ctrl = ['$scope','$routeParams','$location','$timeout','$interval','API','$window','$modal',
	function($scope,$routeParams,$location,$timeout,$interval,API,$window,$modal){

		var scope = $scope;

		scope.date = new Date();

		scope.months = months;
		scope.days = days;

		scope.current_user = API.users.new(current_user);

		zE(function(){
			var zduser = {
				name: scope.current_user['name'],
				email: scope.current_user['email'],
				external_id: scope.current_user['id']
			};
			zE.identify(zduser);
		});

		scope.location = $location.path().split('/');

		scope.users = API.users;

		scope.search = {};

		$scope.$on('$viewContentLoaded',function(event){

			JP($location.url());

			<% if !E.development? %>
				$window.ga('send','pageview',{page: $location.url()});
			<% end %>

		});

		scope.new_col = true;
		scope.searchUsers = function(){

			JP('SEARCH');

			scope.new_col = true;

			var CLEAN = false;

			var tmp = {};
			angular.forEach(scope.search,function(val,key){

				tmp[key] = val;

				if ((key == 'name' || key == 'social') && val && val != ''){
					tmp[key] = '*'+val+'*';
				}

				if (!val || val == ''){
					delete scope.search[key];
					delete tmp[key];
				}

				if (val || val != ""){CLEAN = true;}

			});

			if (CLEAN){

				scope.users.get(tmp,function(){

					if (scope.users.list.length == 0){
						scope.new_col = false;
						JP(scope.new_col);
					} else {
						scope.new_col = true;
					}
					
					track('send','event','Search','People',JSON.stringify({n: scope.users.list.length,v: tmp}),scope.users.list.length);

				});

			}

		};

		scope.createPerson = function(){

			var modalInstance = $modal.open({
				animation: true,
				templateUrl: '/angularjs/templates/new_person.html',
				controller: 'NewPersonCtrl',
				size: null,
				resolve: {
					params: function(){
						return scope.params;
					},
					current_user: function(){
						return scope.current_user;
					},
					person: function(){
						return scope.search;
					}
				}
			});

		};

		scope.doQuickSearch = function(){

			if (scope.quicksearch_form.$valid){
				window.location = '#/people?name='+scope.search.name;
			}

		};
		
		scope.help = function(){

			zE.activate();

		};

		JP('APPLICATION');

	}
];