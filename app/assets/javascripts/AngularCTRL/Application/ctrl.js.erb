// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
// APPLICATION !!!!!!! APPLICATION !!!!!!! APPLICATION !!!!!!! APPLICATION !!!!!!! APPLICATION !!!!!!!
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
var Ctrl = ['$scope','$routeParams','$location','$timeout','$interval','API','$window',
	function($scope,$routeParams,$location,$timeout,$interval,API,$window){

		var scope = $scope;

		scope.months = months;
		scope.days = days;

		scope.current_user = API.users.new(current_user);

		scope.location = $location.path().split('/');

		scope.users = API.users;

		scope.search = {};

		$scope.$on('$viewContentLoaded',function(event){

			JP($location.url());

			<% if !E.development? %>
				$window.ga('send','pageview',{page: $location.url()});
			<% end %>

		});

		scope.searchUsers = function(){

			JP('SEARCH');

			var CLEAN = false;

			var tmp = {};
			angular.forEach(scope.search,function(val,key){

				tmp[key] = val;

				if (key == 'name' && val && val != ''){
					tmp.name = '*'+val+'*';
				}

				if (!val || val == ''){
					delete scope.search[key];
					delete tmp[key];
				}

				if (val || val != ""){CLEAN = true;}

			});

			if (CLEAN){

				scope.users.get(tmp,function(){

					if (scope.users.list.length == 0){
						scope.new_col = false;
					} else {
						scope.new_col = true;
					}
					
					track('send','event','Search','People',JSON.stringify({n: scope.users.list.length,v: tmp}),scope.users.list.length);

				});

			}

		};

		scope.new_col = true;
		scope.createPerson = function(){

			scope.new_person = API.users.new(angular.copy(scope.search));
			scope.new_person.author_id = scope.current_user.id;
			scope.new_person.floating = true;
			scope.new_person.password = 'floating';

			scope.new_person.save(function(user,error){

				if (!error){

					window.location = '#/people/'+user.id;

				} else {

				}

			});

		};

		JP('APPLICATION');

	}
];