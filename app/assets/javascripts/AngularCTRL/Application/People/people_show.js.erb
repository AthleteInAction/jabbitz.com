var PeopleShowCtrl = ['$scope','$routeParams','$location','$timeout','$interval','API','$window','$modal',
	function($scope,$routeParams,$location,$timeout,$interval,API,$window,$modal){

		var scope = $scope;

		scope.params = $routeParams;
		
		scope.search = {};

		scope.new_chime = API.chimes.new({
			author_id: scope.$parent.current_user.id,
			user_id: scope.params.id
		});
		scope.chimes = API.chimes;
		scope.socials = API.socials;

		scope.getChimes = function(){

			scope.search.page = 1;
			scope.chimes.get(scope.search);

		};

		scope.getUser = function(){

			scope.$parent.users.find(scope.params.id,function(user,error){

				if (!error){
					scope.user = API.users.new(user);
					scope.search = {limit: 10,order: '-id',user_id: scope.user.id};
					scope.getChimes();
				}

			});

		};
		scope.getUser();

		JP('PEOPLESHOW');

		// =======
		scope.today = function() {
			scope.new_chime.interaction_date = new Date();
		};

		scope.clear = function () {
			scope.new_chime.interaction_date = null;
		};

		scope.max = 10;
		scope.isReadonly = false;

		$scope.hoveringOver = function(value){

			scope.overStar = value;
			scope.percent = 100 * (value / scope.max);

		};

		scope.ratingStates = [
			{stateOn: 'glyphicon-ok-sign', stateOff: 'glyphicon-ok-circle'},
			{stateOn: 'glyphicon-star', stateOff: 'glyphicon-star-empty'},
			{stateOn: 'glyphicon-heart', stateOff: 'glyphicon-ban-circle'},
			{stateOn: 'glyphicon-heart'},
			{stateOff: 'glyphicon-off'}
		];

		scope.open = function($event){
			
			$event.preventDefault();
			$event.stopPropagation();

			scope.opened = true;

		};

		scope.submitted = false;
		scope.newChimeForm = function(){

			scope.submitted = true;

			if (scope.new_chime_form.$valid) {

				JP('VALID');

				scope.new_chime.save(function(data,error){

					if (!error){

						scope.new_chime = API.chimes.new({
							author_id: scope.$parent.current_user.id,
							user_id: scope.params.id
						});
						scope.chime_collapsed = true;

					}

				});

			} else {

				JP('INVALID');

			}

		};

		scope.simage = function(uri){

			if (uri.match(/facebook.com/i)){
				return 'social-facebook.png';
			}
			if (uri.match(/instagram.com/i)){
				return 'social-instagram.png';
			}
			if (uri.match(/twitter.com/i)){
				return 'social-twitter.png';
			}
			if (uri.match(/pinterest.com/i)){
				return 'social-pinterest.png';
			}

			return 'blank.png';

		};

		scope.openChime = function(chime){

			var c = angular.copy(chime);

			var modalInstance = $modal.open({
				animation: true,
				templateUrl: '/angularjs/templates/chime.html',
				controller: 'ChimeCtrl',
				size: null,
				resolve: {
					params: function(){
						return scope.params;
					},
					current_user: function(){
						return scope.$parent.current_user;
					},
					chime: function(){
						return chime;
					}
				}
			});

			modalInstance.result.then(function(selectedItem){
				scope.selected = selectedItem;
			},function(){
				chime = c;
			});

		};

		scope.deleteChime = function(chime){

			if (!confirm('Are you sure you want to delete this chime?\n\n'+chime.body_short)){
				return false;
			}

			chime.delete();

		};

		scope.flag_col = {};
		scope.flag = function(chime){

			chime.update('flagged','true',function(data,error){

				if (!error){
					scope.flag_col[chime.id] = true;
				}

			});

		};

	}
];